<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    
    <title>Development tips - cfgov-refresh</title>
    
    

    <link rel="stylesheet" href="../css/normalize.css">
    <link rel="stylesheet" href="../css/main.css">
    <link rel="stylesheet" href="../css/syntax.css">
    

    <style type="text/css">
        
        .sidebar-nav a:hover,
        .sidebar-nav a:focus,
        .sidebar-nav a:active,
        .sidebar-nav a.sidebar-nav-active {
            border-left-color: #2CB34A;
        }
        header {
            border-bottom-color: #2CB34A;
        }
        
        

        
    </style>


    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
      <script src="../js/respond.min.js"></script>
    <![endif]--> 
</head>

<body>

    <div class="container">
        <header role="banner">
            <div class="wrap">
                
                <img class="logo" src="https://cfpb.github.io/img/logo_210.png" alt="Consumer Financial Protection Bureau">
                
                <h1 class="site-title"><a class="title-link" href="../">cfgov-refresh</a></h1>
            </div>
        </header>

        <div class="wrap content">
            <aside>
                <nav class="sidebar-nav" role="navigation">
                    <ul>
                        
                        <li>
                            
                            <a href=".." class="">Introduction</a>

                            
                        </li>
                        
                        <li>
                            
                            <a href="../installation/" class="">Installation</a>

                            
                        </li>
                        
                        <li>
                            
                            <a href="../usage/" class="">Usage</a>

                            
                        </li>
                        
                        <li>
                            
                            <span>Building and Deploying for cf.gov</span>
                            <ul class="secondary-nav">
                                
                                <li>
                                    <a href="../new-projects/" class="">New projects</a>
                                </li>
                                
                                <li>
                                    <a href="../branching-merging/" class="">Branching and merging</a>
                                </li>
                                
                                <li>
                                    <a href="../release-cadence/" class="">Release cadence</a>
                                </li>
                                
                                <li>
                                    <a href="../deployment/" class="">Deployment</a>
                                </li>
                                
                                <li>
                                    <a href="../feature-flags/" class="">Feature flags</a>
                                </li>
                                
                            </ul>
                            
                        </li>
                        
                        <li>
                            
                            <span>Back-end guidelines</span>
                            <ul class="secondary-nav">
                                
                                <li>
                                    <a href="../wagtail-migrations/" class="">Wagtail and Django migrations</a>
                                </li>
                                
                                <li>
                                    <a href="../django-to-wagtail/" class="">Wagtail Pages vs Django views</a>
                                </li>
                                
                                <li>
                                    <a href="../forms-in-wagtail/" class="">Forms in Wagtail page context</a>
                                </li>
                                
                                <li>
                                    <a href="../testing-be/" class="">Testing</a>
                                </li>
                                
                                <li>
                                    <a href="../translation/" class="">Translation</a>
                                </li>
                                
                                <li>
                                    <a href="../caching/" class="">Caching</a>
                                </li>
                                
                            </ul>
                            
                        </li>
                        
                        <li>
                            
                            <span>Front-end guidelines</span>
                            <ul class="secondary-nav">
                                
                                <li>
                                    <a href="../atomic-structure/" class="">Atomic structure and design</a>
                                </li>
                                
                                <li>
                                    <a href="../testing-fe/" class="">Testing</a>
                                </li>
                                
                            </ul>
                            
                        </li>
                        
                        <li>
                            
                            <a href="./" class="sidebar-nav-active">Development tips</a>

                            
                        </li>
                        
                        <li>
                            
                            <span>APIs</span>
                            <ul class="secondary-nav">
                                
                                <li>
                                    <a href="../ask-cfpb/" class="">Ask CFPB</a>
                                </li>
                                
                                <li>
                                    <a href="../consumer-complaint-database/" class="">Consumer complaints</a>
                                </li>
                                
                                <li>
                                    <a href="../hmda/" class="">HMDA data</a>
                                </li>
                                
                            </ul>
                            
                        </li>
                        
                    </ul>
                </nav>
            </aside>

            <section id="main" class="main-content" role="main">
                <h2 id="development-tips">Development tips<a class="headerlink" href="#development-tips" title="Permanent link">¶</a></h2>
<h3 id="tip-developing-on-nested-satellite-apps">TIP: Developing on nested satellite apps<a class="headerlink" href="#tip-developing-on-nested-satellite-apps" title="Permanent link">¶</a></h3>
<p>Some projects can sit inside cfgov-refresh, but manage their own asset
dependencies. These projects have their own package.json and base templates.</p>
<p>The structure looks like this:</p>
<h4 id="npm-modules">npm modules<a class="headerlink" href="#npm-modules" title="Permanent link">¶</a></h4>
<ul>
<li>App's own dependency list is in
  <code>cfgov/unprocessed/apps/[project namespace]/package.json</code></li>
<li>App's <code>node_modules</code> path is listed in the Travis config
  <a href="https://github.com/cfpb/cfgov-refresh/blob/master/.travis.yml#L10">https://github.com/cfpb/cfgov-refresh/blob/master/.travis.yml#L10</a>
  so that their dependencies will be available when Travis runs.</li>
</ul>
<h4 id="webpack">Webpack<a class="headerlink" href="#webpack" title="Permanent link">¶</a></h4>
<ul>
<li>Apps may include their own webpack-config.js configuration that adjusts how
  their app-specific assets should be built. This configuration appears in
  <code>cfgov/unprocessed/apps/[project namespace]/webpack-config.js</code></li>
</ul>
<h4 id="templates">Templates<a class="headerlink" href="#templates" title="Permanent link">¶</a></h4>
<ul>
<li>Apps use a jinja template that extends the <code>base.html</code>
  template used by the rest of the site.
  This template would reside in <code>cfgov/jinja2/v1/[project namespace]/index.html</code>
  or similar (for example, <a href="https://github.com/cfpb/cfgov-refresh/blob/master/cfgov/jinja2/v1/owning-a-home/explore-rates/index.html">owning-a-home</a>).</li>
</ul>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>A template may support a non-standard browser, like an older IE version,
by including the required dependencies, polyfills, etc. in its
template's <code>{% block css %}</code> or <code>{% block javascript scoped %}</code> blocks.</p>
</div>
<h3 id="tip-loading-satellite-apps">TIP: Loading satellite apps<a class="headerlink" href="#tip-loading-satellite-apps" title="Permanent link">¶</a></h3>
<p>Some projects fit within the cfgov-refresh architecture,
but are not fully incorporated into the project.
These are known as "satellite apps."</p>
<p>Satellite apps are listed in the
<a href="https://github.com/cfpb/cfgov-refresh/blob/master/requirements/optional-public.txt">optional-public.txt</a>
requirements file.</p>
<p>In addition to the aforementioned list,
<a href="https://github.com/cfpb/hmda-explorer">HMDA Explorer</a> and
<a href="https://github.com/cfpb/rural-or-underserved-test">Rural or Underserved</a>,
have their own installation requirements.</p>
<p>If using Docker, follow
<a href="https://github.com/cfpb/cfgov-refresh/blob/master/docs/usage.md#develop-satellite-apps">these guidelines</a>.</p>
<p>Otherwise, if not using Docker, follow these guidelines:</p>
<ol>
<li>Build the third-party projects per their directions</li>
<li>Stop the web server and return to <code>cfgov-refresh</code></li>
<li>Run <code>pip install -e ../&lt;sibling&gt;</code> to load the projects' dependencies</li>
</ol>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Do not install the projects directly into the <code>cfgov-refresh</code> directory.
Clone and install the projects as siblings to <code>cfgov-refresh</code>,
so that they share the same parent directory (<code>~/Projects</code> or similar).</p>
</div>
<h3 id="tip-loading-data-into-django-models">TIP: Loading data into Django models<a class="headerlink" href="#tip-loading-data-into-django-models" title="Permanent link">¶</a></h3>
<p>The Django management command <code>import-data</code> will import data from the specified
source into the specified model.</p>
<p><pre class="highlight"><code class="linenums">usage: manage.py import-data [-h] [--version] [-v {0,1,2,3}] [--settings SETTINGS]
        [--pythonpath PYTHONPATH] [--traceback] [--no-color] [--parent PARENT]
        [--snippet] -u USERNAME -p PASSWORD [--app APP] [--overwrite]
        data_type wagtail_type</code></pre>
- <code>data_type</code> is the WordPress post type defined in the <code>processors.py</code> file.
- <code>wagtail_type</code> is the Django model name where the data is going to go.
- <code>-u</code> and <code>-p</code> are credentials to an admin account.</p>
<p>Required option:</p>
<ul>
<li><code>--parent</code> is the slug of the parent page that the pages will exist
  under.</li>
<li><code>--snippet</code> is a flag that's used to signify that the importing data will be
  inserted into a Django model, registered as a <a href="http://docs.wagtail.io/en/v1.1/topics/snippets.html">Wagtail snippet</a>.
  One of these options must be set for the command to run.</li>
</ul>
<p>Other options:</p>
<ul>
<li><code>--app</code> is the name of the app the Django models from <code>wagtail_type</code> exist in.
  It defaults to our app, <code>v1</code>.</li>
<li><code>--overwrite</code> overwrites existing pages in Wagtail based on comparing slugs.
Be careful when using this as it will overwrite the data in Wagtail with data
from the source. Default is <code>False</code>.</li>
<li><code>--verbosity</code> is set to 1 by default. Set it to 2 or higher and expect the
name of the slugs to appear where appropriate.</li>
</ul>
<p>For now, in order for this command to import the data, one of the things it
needs is a file for "sheer logic" to use to retrieve the data. For us, the
processors are already done from our last backend. This part of the command
will change as we move away from our dependency on "sheer logic." This is set
by putting the file in a <code>processors</code> module in the top level of the project
and adding it to the setting <a href="https://github.com/cfpb/cfgov-refresh/blob/master/cfgov/cfgov/settings/base.py#L218"><code>SHEER_PROCESSORS</code></a>.</p>
<p>The command needs a <code>processors</code> module in the app that's passed to it, as well
as a file with the same name as the Django model specified that defines a class
named <code>DataConverter</code> that subclasses either <code>_helpers.PageDataConverter</code> or
<code>_helpers.SnippetDataConverter</code> and implements their method(s) explained below:</p>
<p><strong>PageDataConverter</strong>:</p>
<ul>
<li><strong>convert(self, imported_data)</strong>:
   For converting pages or snippets, the processor file must implement the
   <strong>convert()</strong> function with one argument. That argument represents the
   imported data dictionary. That function must take the dictionary and map it
   to a new one that uses the keys that Wagtail's <strong>create()</strong> and <strong>edit()</strong>
   admin/snippet view functions expect in the <code>request.POST</code> dictionary to
   actually migrate the data over, and then returns that dictionary where it
   will be assigned to <code>request.POST</code>.</li>
</ul>
<p><strong>SnippetDataConverter(PageDataConverter)</strong>:</p>
<ul>
<li><strong>get_existing_snippet()</strong>
   This also accepts the imported data dictionary. It's used to find an
   existing snippet given the imported data, returning it if found or <code>None</code> if
   not.</li>
</ul>
<h3 id="tip-working-with-the-templates">TIP: Working with the templates<a class="headerlink" href="#tip-working-with-the-templates" title="Permanent link">¶</a></h3>
<h4 id="front-end-templateasset-locations">Front-End Template/Asset Locations<a class="headerlink" href="#front-end-templateasset-locations" title="Permanent link">¶</a></h4>
<p><strong>Templates</strong> that are served by the Django server: <code>cfgov\jinja2\v1</code></p>
<p><strong>Static assets</strong> prior to processing (minifying etc.): <code>cfgov\unprocessed</code>.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>After running <code>gulp build</code> the site's assets are copied over to <code>cfgov\static_built</code>,
ready to be served by Django.</p>
</div>
<h4 id="simple-static-template-setup">Simple static template setup<a class="headerlink" href="#simple-static-template-setup" title="Permanent link">¶</a></h4>
<p>By default, Django will render pages with accordance to the URL pattern defined
for it. For example, going to <code>http://localhost:8000/the-bureau/index.html</code>
(or <code>http://localhost:8000/the-bureau/</code>) renders <code>/the-bureau/index.html</code> from
the <code>cfgov</code> app folder's <code>jinja2/v1</code> templates folder as processed
by the <a href="http://jinja.pocoo.org/docs">Jinja2</a> templating engine.</p>
<h3 id="tip-outputting-indexed-content-in-a-sheer-template">TIP: Outputting indexed content in a Sheer template<a class="headerlink" href="#tip-outputting-indexed-content-in-a-sheer-template" title="Permanent link">¶</a></h3>
<p>Most of our content is indexed from the API output of our WordPress back-end.
This happens when the <code>python cfgov/manage.py sheer_index -r</code> command is run.</p>
<p>There are two ways in which we use indexed content:
repeating items (e.g., blog posts and press releases),
and single pages (e.g., the Future Requests page in Doing Business with Us).
What follows is a deeper dive into both of these content types.</p>
<h4 id="single-content">Single content<a class="headerlink" href="#single-content" title="Permanent link">¶</a></h4>
<p>To access a single piece of content,
the easiest thing to do is use the <code>get_document()</code> function.</p>
<p>Using the example given earlier of the Future Requests page,
here's how it's done:</p>
<pre class="highlight"><code class="language-jinja linenums">{% set page = get_document('pages', '63169') %}
{{ page.content | safe }}</code></pre>

<p>The <code>get_document</code> method can be used to retrieve a single item of any post type
for display within a template.
In the below example we get an instance of the non-hierarchical
<code>contact</code> post type using its slug (<code>whistleblowers</code>):</p>
<pre class="highlight"><code class="language-jinja linenums">{% set whistleblowers = get_document('contact', 'whistleblowers') %}</code></pre>

<p>In practice, many of our templates are a Frankenstein-type mixture
of hand-coded static content and calls to indexed content,
as we continually try to strike the right balance of what content
is appropriate to be edited by non-developers in Wagtail,
and what is just too fragile to do any other way than by hand.</p>
<h3 id="tip-filtering-results-with-queries">TIP: Filtering results with queries<a class="headerlink" href="#tip-filtering-results-with-queries" title="Permanent link">¶</a></h3>
<p>Sometimes you'll want to create queries in your templates to filter the data.</p>
<p>The two main ways of injecting filters into your data are in the URL's query
string and within the template code itself.</p>
<p>We have a handy function <code>search()</code> that:</p>
<ol>
<li>Pulls in filters from the URL query string.</li>
<li>Allows you to add additional filters by passing them in as arguments to the function.</li>
</ol>
<h4 id="url-query-string-filters">URL query string filters<a class="headerlink" href="#url-query-string-filters" title="Permanent link">¶</a></h4>
<p>URL query string filters can be further broken down into two types:</p>
<ol>
<li>Term - Used when you want to filter by whether a field matches a term.
Note that in order to use this type of filter,
the field you are matching it against must have
<code>"index": "not_analyzed"</code> set in the mapping.</li>
<li>Range - Used for when you want to filter something by a range (e.g. dates or numbers)</li>
</ol>
<p>An example of Term is:</p>
<p><code>?filter_category=Op-Ed</code></p>
<p><code>filter_[field]=[value]</code></p>
<p>An example of Range is:</p>
<p><code>?filter_range_date_gte=2014-01</code></p>
<p><code>filter_range_[field]_[operator]=[value]</code></p>
<p>URL query string filters are convenient for many of the filtered queries you'll need to run,
but often there are cases where you'll need more flexibility.</p>
<h4 id="more-complex-filters">More complex filters<a class="headerlink" href="#more-complex-filters" title="Permanent link">¶</a></h4>
<p>By default, <code>search()</code> uses the default query parameters
defined in the <code>_queries/object-name.json</code> file,
then mixes them in with any additional arguments
from the URL query string in addition to what is passed into the function itself.</p>
<p>When using <code>search()</code>, you can also pass in filters with the same <code>filter_</code> syntax as above.</p>
<p>For example:</p>
<p><code>search(filter_category='Op-Ed')</code></p>
<p>Multiple term filters on the same field will be combined in an OR clause, while
term filters of different fields will be combined in an AND clause.</p>
<p>For example:</p>
<p><code>search(filter_tag='Students', filter_tag='Finance', filter_author='Batman')</code></p>
<p>This will return documents that have the tag Students OR Finance, AND have an author of Batman.</p>
<p>If you need more control over your filter than that,
enter it manually in the <code>cfgov/jinja2/v1/_queries/[filtername].json</code> file.</p>
<h3 id="tip-debugging-site-performance">TIP: Debugging site performance<a class="headerlink" href="#tip-debugging-site-performance" title="Permanent link">¶</a></h3>
<p>When running locally it is possible to enable the
<a href="https://django-debug-toolbar.readthedocs.io/en/stable/">Django Debug Toolbar</a>
by defining the <code>ENABLE_DEBUG_TOOLBAR</code> environment variable:</p>
<pre class="highlight"><code class="language-sh linenums">$ ENABLE_DEBUG_TOOLBAR=1 ./runserver.sh</code></pre>

<p>This tool exposes various useful pieces of information about things like HTTP headers,
Django settings, SQL queries, and template variables. Note that running with the toolbar on
may have an impact on local server performance.</p>
<h3 id="tip-updating-the-documentation">TIP: Updating the documentation<a class="headerlink" href="#tip-updating-the-documentation" title="Permanent link">¶</a></h3>
<p>Our documentation is written as Markdown files and served in GitHub pages
by <a href="http://www.mkdocs.org/user-guide/deploying-your-docs/">mkdocs</a>.</p>
<p>To update the docs in GitHub Pages once a pull request has been merged,
mkdocs provides <a href="http://www.mkdocs.org/user-guide/deploying-your-docs/">a helpful command</a>:</p>
<pre class="highlight"><code class="linenums">mkdocs gh-deploy --clean</code></pre>
            </section>
        </div>

        <footer role="contentinfo">
            <div class="wrap">
                This project is maintained by <a href="https://cfpb.github.io">The Consumer Financial Protection Bureau</a>.

                <p>Hosted on <a href="http://pages.github.com/">GitHub Pages</a>.</p>
            </div>
        </footer>
    </div>
</body>
</html>
